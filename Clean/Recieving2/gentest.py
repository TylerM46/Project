import numpy as np
from PIL import Image

readdata = "11001010101010101010110010011010100110011011010000110101111000111001100100001011001101000001011101101000001011001101000001011001101100001011001101000001011001101000001010100000100101111101001100101011001000100001011101001100101100001101100101011001010011110101011111011110100101001111000010100000001100110000000101101011000100101100010100000101100111001101001100110100100001100111001101000101110100000100001011001001100101011001100101101010101101000001111101101100100111001110011110100010010100101111101101100100010100000001100110000000101101011000100101100010100000101100111001101001100110100000101100110100001000001010100000101100111001001111001111101000100001010101101001000110101101100101111101001000101111001101000101100001001111000111001100100001010101101000001011000001000001011001101000001011101001100001011001101100101011101001100101110100000100001011001010011010000010101100110011110110001100111000001000010000010001111010000111110111010100101001100100111001100100001010100000100001011000001000000110101100100001011001101101100110100000100000111001101000101110100000101100110101101000001111110100101101011001101001100111000100001101011001010011010001011111011010000110110011000110101100001100110101101001101011000100101100010100000101100111001101001100110100000101100110100001000001010000000101100110100000100010000010101000001010101101000001011100001000001011001010011010001011111011010100110110011001011101000100001010100000100001011000000101100110100000101101011001101101100111000000100000110101100101100110101101001101011001101000010100010001100101111101101100101100001101100101111110110011010001011111011010100110110011001011001101100110010101101000001011001101000000111001100100001011001101101101011001101000000111001100101100110101101000001011001101000010000010101100110011001101000001011101101000101011101010011001101011111011110100110110011000010100000101100111101001101100110100100101100010100000101100111001101001000110100000101100110100000100001010100000101100110100000101110011110101100101111000001000001011001101000101011001001111001101011111011010000010110011000110100000001000110101101000101111100100101100010100000001000111001101001100110100000101100110100001000001010100001001100111001100100010011110110000110011001101000001011101101000101111110101100101101011111011110100110110011000110100000101100110101100100101111101101000001011001101000001011101001100001011101101000000110100001100101111101001100101111110101100110011110110111010111101101101100111001001000110011110101111001100110010111010000110110011101011001100101100110100000100001111101101000000111000000101100111001101000001011000000101100010100001000001011001101001100110100000101101111101001001101010100100100000111001001000101111001001000001010100000100101100001001111001011001100101100110000100000001011001001100100010000100001000011001101001100110100000101100110100001000001011000001001100010101100101101111001001001101011000000100000111010101000101110101100100001010000100000001011001001100100110100001100101110100000101100110101001100100110100100101100111001101000001011000000101100110100001100001111101101000000111001000100010011110110000101100001101100101011110010011001111001100101101010000000101101011010110011001011001101100101100010110000101111101001100110000001010000101100110110011110000001100101101111101010111110101010010110010100111010110011000110011111110101110011010111001011011010011100111101000001010000100101100111001100100000110100001100101100110010110010100110101100111000110011110011001111111010011001000000101110100010011110111101111111110111001111011010111101011111110011001111111010111001011011010011101011100101101010000100101100010100100001100010000100001000011101001111010000001001100110000001010000101100001001100101111101100101101010101101100001011101101000101011001000101101110100001101100111100000100100110110100101101110000100101100110000100001000010000100001000010000100001000011001100100000110101101001101011000000101000010100100001100110000000101100110000100101000010100100000000010001100001001010000101101000011100100011000110110100101110010100000101100110100100101000010000000101100110000100101100011101001000000110101101001101111001101001100111001100100001010100000101101010100001100001000001101011001011010101000010111001110100001001001101010001011111101000111011101000001000010100000101100110101100101100110100101000000111101001000101011001001001110011101010000101100001001000101111000000101001111001110100101100101001111101111111101100111011101011000101101001001110001111111001100111011001000101100110100000101100110001100101001011000001100101011001100100101011001001001110011101101100001011101101000101011000000101001011000010000001000001101011001011010101000010111001110100001000101101011100111010001000011011001100101000011101001000101111001101001101111101101000000111000000000000110101001000001111001101001100111101100100001010100000101001010100001100000111101100111000110110100101110010100010001100100000000111000110110000101110110100010000101100110110011001111110101100001011000000101100011001100100000110101001000001111001101001100111000000100001010100000101101010100001001100111100000100100110101000101101110100010001100100000000111000110110100101110010100010111110100110110011001111101001000001010100001001100011001100100000110101101000001111001101001100111001100100001010101100101100110100001000000111100000100100110101000101101110100001101100100000000111000110110100101110111101110111010000010101100101011001001000001010100001001100110100000100000110101101001101011000001001100111001100100001010100000101100110100001001100111100000100100110101000101001110100010001100111100000100100110110100101110111001111001010101010101010110010011010100110011011010000110101111"


def binary_to_image(binary_string, width, height, channels):
    # Convert binary string to byte array
    byte_array = bytearray()
    for i in range(0, len(binary_string), 3):
        byte = binary_string[i:i+3]
        byte_array.append(int(byte, 2) * 32)  # Scale back to original color range

    # Convert byte array to numpy array
    img_array = np.array(byte_array, dtype=np.uint8).reshape((height, width, channels))

    # Create and save image
    img = Image.fromarray(img_array, mode='RGB')
    
    img.save('./flip.jpg')
    print("made it")

def extractdata(binary_string, pattern):
    positions = []   #array of instance positions 
    start = 0

    # Find all start positions of the pattern
    while True:
        idx = binary_string.find(pattern, start)
        if idx == -1:
            break
        positions.append(idx)
        start = idx + 1  # allow overlapping

    # Extract sequences between each pair of occurrences
    results = []
    for i in range(len(positions) - 1):
        start_idx = positions[i] + len(pattern)
        end_idx = positions[i + 1]
        results.append(binary_string[start_idx:end_idx])

    return results

def flip_every_5th_bit(binary_str):
    """
    Flips every 5th bit (i.e., indices 4, 9, 14, ...) back to correct errors.
    """
    bit_list = list(binary_str)
    for i in range(4, len(bit_list), 5):
        bit_list[i] = '0' if bit_list[i] == '1' else '1'
    return ''.join(bit_list)


# Example usage
pattern = "110010101010101010101100"
segments = extractdata(readdata, pattern)

#print(segments,len(segments[0]))
sent = flip_every_5th_bit(segments[0])

width = 25 # Replace with actual width
height = 25  # Replace with actual height
channels = 3  # RGB

binary_to_image(sent, width, height, channels)

print(sent, len(sent))

#for i in segments:
#    if i 